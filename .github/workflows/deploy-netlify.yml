# 1. Nome do Workflow: Será exibido na aba 'Actions' do GitHub
name: CI/CD da Aplicação Angular para Netlify

# 2. Gatilho (Trigger): Quando este workflow será executado
on: 
    # Executa o workflow sempre que houver um 'push' (envio de código)
  push:
    # Apenas na branch 'main'
    branches:
      - master 

# 3. Definição dos Trabalhos (Jobs): O que o workflow fará
jobs:
  # Nome do trabalho principal: 'build_and_deploy'
  build_and_deploy:
    # O trabalho será executado em um ambiente (máquina virtual) Ubuntu mais recente
    runs-on: ubuntu-latest
    
    # Passos (Steps) que o trabalho executará em ordem
    steps:
      
      # PASSO 1: Preparar o ambiente e obter o código
      - name: Checkout do Repositório
        # Usa a ação oficial do GitHub para baixar o código do repositório na VM
        uses: actions/checkout@v4

      # PASSO 2: Configurar o ambiente Node.js
      - name: Configurar Node.js
        uses: actions/setup-node@v4
        with:
          # Define a versão do Node.js a ser usada
          node-version: '20' 

      # PASSO 3: Instalar as dependências do Angular
      - name: Instalar Dependências (node_modules)
        # Comando para instalar todos os pacotes definidos no package.json
        run: npm install

      # PASSO 4: Integração Contínua (CI) - Construção (Build)
      # O comando Angular que realiza o build do projeto em modo produção
      # executa npm run build, que compila o código-fonte em arquivos estáticos
      - name: Construir Aplicação Angular em Modo Produção (Build)
        # O comando 'ng build' compila a aplicação para arquivos estáticos
        # "--configuration production" garante a otimização e o modo de produção
        run: npm run build -- --configuration production
      
      # PASSO 5: Entrega Contínua (CD) - Deploy no Netlify
      - name: Realizar Deploy no Netlify
        # Usa a ação de terceiros
        uses: nwtgck/actions-netlify@v3.0 
        with:
          # PUBLISH-DIR: A pasta gerada pelo build do Angular
          publish-dir: './dist/loja-tp1-angular' 
          production-branch: master
          
          # PARTE CRUCIAL: Passando o Token de Autenticação
          # O Netlify Action usa o token passado no 'with'
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
        
        # O bloco 'env' é uma camada de segurança extra para garantir o acesso ao token
        # NETLIFY_AUTH_TOKEN é a única variável de ambiente necessária aqui
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}